'''
Created on 30 Dec 2016

@author: 611370417
'''
import cx_Oracle


def make_Connection() :#
    try:
        conn = cx_Oracle.connect('sparkmaya/sparkmaya@127.0.0.1/XE')
        get_tables_metadata(conn)
        conn.close()
    except cx_Oracle.DatabaseError,exception:
        print(exception.message)
        print("Failed to connect to SparkMaya Master Database")


def get_tables_metadata(conn,connection_id=1):
    
    print 'Inside get_tables_metadata'
    cur = conn.cursor()
    connection = cur.execute('select * from connection_detail where id=%s' %(connection_id))    
        
    for connect in connection:
        try:
            # connection string and connect to source oracle db
            entryconn = cx_Oracle.connect(connect[4],connect[5],connect[9])
            print "Connection Valid. Fetching table metadata"
            
            # fetch tables for the schema
            entrycurr = entryconn.cursor()
            resultset = entrycurr.execute("select table_name from dba_tables where owner='%s'" %(connect[6]))
            
            tablesql = "INSERT INTO PRIME_METADATA_TABLES (CONNECTION_ID,TABLE_NAME) VALUES (:cid, :tname)"
            columnsql = "INSERT INTO PRIME_METADATA_COLUMNS (TABLE_ID,COLUMN_NAME,COLUMN_TYPE) VALUES (:tid, :cname, :ctype)"
            
            # insert tables entries into metadata_tablez
            for table in resultset:
                
                insertcurr = entryconn.cursor()
                print table[0]
                insertcurr.execute(tablesql,cid=connection_id,tid=table[0])
                insertcurr.close()
                
                
                # get id (generated by sequence for above table. This value goes into table_id
                seqid = entryconn.cursor()
                tableid = seqid.fetchone("select id from PRIME_METADATA_TABLES where connection_id=%s and table_name='%s'" %(connection_id, table[0]))
                seqid.close()
                # get column name for the table
                colscurr = entryconn.cursor()
                colsList = colscurr.execute("select column_name, data_type from all_tab_columns where table_name='%s'" %(result[0]))
                
                
                for cols in colsList:
                    print cols[0],cols[1]
                    colscurr = entryconn.cursor()
                    colscurr.execute(columnsql, tid=tableid[0], cname=cols[0], ctype=cols[1])     
                    colscurr.close()
                 
            
            entrycurr.close()
            entryconn.commit()
            entryconn.close()
            
        except cx_Oracle.DatabaseError, exception:
            print 'Error in get_table_metadata'
            print(exception.message)
    
    cur.close()
    
    

if __name__ == '__main__':
    make_Connection()